<html>
    <head>  
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
        <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous">
        </script>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

        <script>
            render = {
                exercises: function ( data ) {
                    let context = $( '#exercises' ).get()[0];

                    for (let level of data.levels) {
                        let e = '<li><div class="collapsible-header">' + (level.name) +  '</div><div class="collapsible-body collection">';

                        for (let exercise of data.exercises) {
                            if ( exercise.level_id == level.id ) {
                                e += '<a class="collection-item" onclick="requests.exercise( this )" data-exercise="' + (exercise.id) + '">' + (exercise.name) + '</a>';
                            }
                        }

                        e += '</div></li>';

                        $( '.collapsible', context).append( e );
                    }
                },
                currentExercise: function ( e ) {
                    let context = $( '#exercises' ).get()[0];

                    $( '.collection-item', context ).removeClass( 'active' );
                    $( e ).addClass( 'active' );
                },
                question: function ( data ) {
                    let context = $( '#question' ).get()[0];

                    $( '.collection-header h4', context ).html( data.question );

                    if ( typeof data.answers == 'undefined' ) {
                        $( '#answer', context ).html( 
                            `<input type="text" value="">
                            <div class="btn right">Submit</div>` 
                        );
                    } else {
                        let e = '';

                        for (let i in data.answers) {
                            e += '<a class="collection-item">' + ( +i + 1 ) + ') ' + ( data.answers[i].answer ) + '</a>';
                        }

                        $( '#answer', context ).html( e );
                    }
                },
                progress: function ( data ) {
                    let context = $( '#progress' ).get()[0];

                    $( '#completed', context ).html( ( data.current ) + ' out of ' + ( data.total ) + ' completed' );
                    $( '#correct', context ).html( ( data.current - +data.incorrect ) + ' out of ' + ( data.current ) + ' correct' );
                    $( '#incorrect', context ).html( ( +data.incorrect ) + ' out of ' + ( data.current ) + ' incorrect' );
                    $( '.determinate', context ).css( { width: ( data.current * 100 / data.total ) + '%' } );
                }
            };

            let requests = {
                exercise: function ( e ) {
                    render.currentExercise( e );
                    socket.emit( 'exercise', { id: e.dataset.exercise } );
                },
            };

            $( function () {
                $('.collapsible').collapsible();

                socket = io( 'http://localhost:3000' );
            
                socket.once( 'connect' , () => {
                    exercise = null;

                    socket.emit( 'exercises', {}, ( data ) => {
                        render.exercises( data );
                        let context = $( '#exercises' ).get()[0];
                    } );

                    socket.on( 'question', ( data ) => {
                        render.question( data );
                    } );

                    socket.on( 'progress', ( data ) => {
                        render.progress( data );
                    } ) ;
                } );

                socket.on( 'disconnect', () => {
                    window.location.reload();
                } );
            } );
        </script>

        <style>
            .container {
                width: 100%;
                max-width:initial;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col s12 m4 l2">
                    <div id="exercises">
                        <ul class="collapsible"></ul>
                    </div>
                </div>
                <div class="col s12 m8 l6">
                    <div id="question" class="collection with-header">
                        <div class="collection-header"><h4>What is the meaning of life? __</h4></div>
                        <div id="answer">
                        </div>
                    </div>
                </div>
                <div class="col s12 m12 l4">
                    <div id="progress" class="collection with-header">
                        <div class="collection-header">
                            <h5>Progress</h5>
                            <div class="progress">
                                <div class="determinate" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="completed" class="collection-item">0 out of 0 completed</div>
                        <div id="correct" class="collection-item green-text">0 out of 0 correct</div>
                        <div id="incorrect" class="collection-item red-text">0 out of 0 incorrect</div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>